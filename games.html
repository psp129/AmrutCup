<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Sample Website</title>

  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

  <style>

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Quicksand', sans-serif;
      background-color: #f2f2f2;
    }

    /* NAVIGATION */
    nav {
      background-color: #230b8d;
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    nav h1 {
      margin: 0;
      font-size: 24px;
    }

    nav ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
    }

    nav ul li {
      margin-left: 20px;
    }

    nav ul li a {
      color: white;
      text-decoration: none;
      font-weight: bold;
    }

    /* HERO SECTION */
    .hero {
      background-color: #092747;
      color: white;
      padding: 60px 30px;
      text-align: center;
    }

    .hero h2 {
      font-size: 36px;
    }

    .hero p {
      font-size: 18px;
      margin-top: 10px;
    }

    /* CONTENT SECTION */
    .content {
      padding: 40px 30px;
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-top: -30px;
    }

    input, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 16px;
    }

    button {
      background-color: #d2c810;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background-color: #5ed117;
    }
  </style>
</head>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bracket plugin CSS & JS -->
<link rel="stylesheet" href="https://www.aropupu.fi/bracket/jquery-bracket/dist/jquery.bracket.min.css">
<script src="https://www.aropupu.fi/bracket/jquery-bracket/dist/jquery.bracket.min.js"></script>

<body>

  <!-- NAVBAR -->
  <nav>
    <h1>Amrut Cup</h1>
    <ul>
      <li><a href="interface.html">Home</a></li>
      <li><a href="games.html">Games</a></li>
      <li><a href="profile.html">Profile</a></li>
    </ul>
  </nav>

  <div class="court-grid">
    <div class="court-box">
      <h2>Court 1 (K1)</h2>
      <p id="Court1-team1">Team A</p> vs <p id="Court1-team2">Team B</p>
    </div>
    <div class="court-box">
      <h2>Court 2 (K1)</h2>
      <p id="Court2-team1">Team A</p> vs <p id="Court2-team2">Team B</p>
    </div>
    <div class="court-box">
      <h2>Court 3 (K1)</h2>
      <p id="Court3-team1">Team A</p> vs <p id="Court3-team2">Team B</p>
    </div>
    <div class="court-box">
      <h2>Court 4 (K1)</h2>
      <p id="Court4-team1">Team A</p> vs <p id="Court4-team2">Team B</p>
    </div>
    <div class="court-box">
      <h2>Court 5 (K2)</h2>
      <p id="Court5-team1">Team A</p> vs <p id="Court5-team2">Team B</p>
    </div>
    <div class="court-box">
      <h2>Court 6 (K2)</h2>
      <p id="Court6-team1">Team A</p> vs <p id="Court6-team2">Team B</p>
    </div>
  </div>
  
  <div class="leaderboard-box">
   <div class="court-box">
    <h2>K1 Leaderboard</h2>
    <ul id="leaderboard-k1"></ul>
   </div>
   
    <div class="court-box">
      <h2>K2 Leaderboard</h2>
      <ul id="leaderboard-k2"></ul>
    </div>
  </div>

  
  

  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-database-compat.js"></script>

<script>

  const firebaseConfig = {
    apiKey: "AIzaSyACxsbxzBQ_Wk6diSeU2ejMPZu2ajgQWaI",
  authDomain: "amrutcup-f7225.firebaseapp.com",
  databaseURL: "https://amrutcup-f7225-default-rtdb.firebaseio.com",
  projectId: "amrutcup-f7225",
  storageBucket: "amrutcup-f7225.firebasestorage.app",
  messagingSenderId: "540970777934",
  appId: "1:540970777934:web:19699b90ff40aa2fedf21f",
  measurementId: "G-DJPX5SH2EH"
  };


  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  
  async function generateMatchSchedule() {
  const snapshot = await firebase.database().ref("Teams").once("value");
  const groupedTeams = { K1: [], K2: [] };

  snapshot.forEach(groupSnap => {
    const groupKey = groupSnap.key; // should be 'K1' or 'K2'
    groupSnap.forEach(teamSnap => {
      const teamData = teamSnap.val();
      if (teamData.name && groupedTeams[groupKey]) {
        groupedTeams[groupKey].push(teamData.name);
      }
    });
  });

  function generateMatches(teams, maxMatches = 4) {
    const matches = [];
    const matchCount = {};

    teams.forEach(t => matchCount[t] = 0);

    for (let i = 0; i < teams.length; i++) {
      for (let j = i + 1; j < teams.length; j++) {
        const t1 = teams[i];
        const t2 = teams[j];

        if (matchCount[t1] < maxMatches && matchCount[t2] < maxMatches) {
          matches.push({ team1: t1, team2: t2 });
          matchCount[t1]++;
          matchCount[t2]++;
        }
      }
    }

    return matches;
  }

  return {
    K1: generateMatches(groupedTeams.K1),
    K2: generateMatches(groupedTeams.K2)
  };

  console.log("generateMatchSchedule triggered");

}


async function assignInitialMatchesToCourts() {
  const matchesByGroup = await generateMatchSchedule();
  const k1Matches = matchesByGroup.K1;
  const k2Matches = matchesByGroup.K2;

  const scheduledTeams = new Set();

  async function assignMatches(matches, courtStartIndex, courtEndIndex) {
    let courtIndex = courtStartIndex;

    for (let i = 0; i < matches.length && courtIndex <= courtEndIndex; i++) {
      const match = matches[i];
      const { team1, team2 } = match;

      if (scheduledTeams.has(team1) || scheduledTeams.has(team2)) continue;

      const courtRef = firebase.database().ref(`Courts/Court${courtIndex}`);
      await courtRef.set({
        team1,
        team2,
        score1: 0,
        score2: 0
      });

      scheduledTeams.add(team1);
      scheduledTeams.add(team2);
      courtIndex++;
    }

    return matches.filter(
      match => !(scheduledTeams.has(match.team1) || scheduledTeams.has(match.team2))
    );
  }

  const remainingK1 = await assignMatches(k1Matches, 1, 4);
  const remainingK2 = await assignMatches(k2Matches, 5, 6);

  await firebase.database().ref("ScheduledMatches/K1").set(remainingK1);
  await firebase.database().ref("ScheduledMatches/K2").set(remainingK2);

  console.log("assignInitialMatchesToCourts triggered");

}




function setupCourtRotation() {
  for (let i = 1; i <= 6; i++) {
    const courtRef = firebase.database().ref(`Courts/Court${i}`);

    courtRef.on("child_changed", async (snapshot) => {
      if (snapshot.key === "finished" && snapshot.val() === true) {
        let group = i <= 4 ? "K1" : "K2";
        const queueRef = firebase.database().ref(`ScheduledMatches/${group}`);
        const queueSnapshot = await queueRef.once("value");
        const queue = queueSnapshot.val();

        if (queue && queue.length > 0) {
          const nextMatch = queue.shift();

          await courtRef.set({
            team1: nextMatch.team1,
            team2: nextMatch.team2,
            score1: 0,
            score2: 0
          });

          await queueRef.set(queue);
        }
      }
    });
  }
}


function listenToCourts() {
  const courtsRef = db.ref("Courts");

  courtsRef.on("value", (snapshot) => {
    const data = snapshot.val();

    for (const court in data) {
      const match = data[court];

      const t1El = document.getElementById(`${court}-team1`);
      const t2El = document.getElementById(`${court}-team2`);

      if (t1El) t1El.textContent = match.team1 || "TBD";
      if (t2El) t2El.textContent = match.team2 || "TBD";
    }
  });
}

async function leaderboard(group, leaderboardElementId){
  const courtsRef = db.ref("Courts");
  const snapshot = await courtsRef.once("value");

  const teamDiffs = {};

  snapshot.forEach(child => {
    const match = child.val();
    if (!match.team1 || !match.team2) return;

    // Only process matches for the given group (K1 or K2)
    if (!match.team1.startsWith(group) && !match.team2.startsWith(group)) return;

    const t1 = match.team1;
    const t2 = match.team2;
    const s1 = match.score1 || 0;
    const s2 = match.score2 || 0;

    // Initialize differential totals
    if (!(t1 in teamDiffs)) teamDiffs[t1] = 0;
    if (!(t2 in teamDiffs)) teamDiffs[t2] = 0;

    // Update point differentials
    teamDiffs[t1] += s1 - s2;
    teamDiffs[t2] += s2 - s1;
  });
  const sorted = Object.entries(teamDiffs).sort((a, b) => b[1] - a[1]);

  const ul = document.getElementById(leaderboardElementId);
  ul.innerHTML = '';
  sorted.forEach(([team, diff], index) => {
    const li = document.createElement('li');
    li.textContent = `${index + 1}. ${team} (Diff: ${diff})`;
    ul.appendChild(li);
  });
  
}

 
assignInitialMatchesToCourts();
setupCourtRotation();
listenToCourts();
leaderboard("K1", "leaderboard-k1");
leaderboard("K2", "leaderboard-k2");

  </script>

</body>
</html>